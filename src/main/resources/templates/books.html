<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <title>Search Books</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
<div class="top-background"></div>
<div th:replace="fragments/navbar.html"></div> <!-- Include Navbar -->

<div class="container mt-4">
    <h1 class="text-center">Search Books</h1>

    <!-- Search Tabs -->
    <ul class="nav nav-tabs" id="searchTabs">
        <li class="nav-item">
            <a class="nav-link active" href="#" data-search="author">Author</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-search="title">Title</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" data-search="isbn">ISBN</a>
        </li>
    </ul>

    <!-- Search Input -->
    <div class="mt-3">
        <input type="text" id="searchInput" class="form-control" placeholder="Search...">
    </div>

    <!-- Book Table -->
    <table class="table table-striped table-bordered mt-3">
        <thead>
        <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Author</th>
            <th>ISBN</th>
            <th>Availability</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody id="booksTable">
        <tr th:each="book : ${books}">
            <td th:text="${book.id}"></td>
            <td th:text="${book.title}"></td>
            <td th:text="${book.author}"></td>
            <td th:text="${book.isbn}"></td>
            <td th:text="${book.available ? 'Available' : 'Unavailable'}"></td>
            <td>
                <button class="btn btn-primary borrow-button" th:attr="data-book-id=${book.id}">Borrow</button>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        let activeSearchType = "author"; // Default search type

        // Handle tab clicks
        document.querySelectorAll("#searchTabs .nav-link").forEach(tab => {
            tab.addEventListener("click", function (event) {
                event.preventDefault();
                document.querySelectorAll("#searchTabs .nav-link").forEach(t => t.classList.remove("active"));
                this.classList.add("active");
                activeSearchType = this.getAttribute("data-search");
                document.getElementById("searchInput").value = "";
                filterBooks();
            });
        });

        // Filter function
        document.getElementById("searchInput").addEventListener("input", filterBooks);

        function filterBooks() {
            let query = document.getElementById("searchInput").value.toLowerCase();
            document.querySelectorAll("#booksTable tr").forEach(row => {
                let text = row.querySelector(`td:nth-child(${activeSearchType === 'title' ? 2 : activeSearchType === 'author' ? 3 : 4})`).textContent.toLowerCase();
                row.style.display = text.includes(query) ? "" : "none";
            });
        }

        // Borrow button functionality
        document.querySelectorAll(".borrow-button").forEach(button => {
            button.addEventListener("click", function () {
                const bookId = this.getAttribute("data-book-id");
                fetch(`/api/borrowings/${bookId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Failed to borrow book");
                        }
                        return response.json();
                    })
                    .then(data => {
                        alert("Book borrowed successfully!");
                        location.reload();
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        alert("Error borrowing book");
                    });
            });
        });
    });
</script>
</body>
</html>
